<?xml version="1.0" encoding="Windows-1251"?>
<CustomReportsListd><item id="{2E97B592-F966-4224-B6AB-97F001D76D61}" name="GCRemover" description="Отчет показывает на смены каких операторов  могут попадать сессии,  удаленные программой GCRemover.&#xA;Напоминаем!!! Оператор может использовать программу GCRemover для удаления сессий только в том случае,&#xA;если ему ИЗВЕСТЕН ПАРОЛЬ МЕНЕДЖЕРА!&#xA;Используйте &quot;сильные&quot; пароли, своевременно их меняйте и проверяйте компьютер менеджера на наличие&#xA;кейлоггеров.&#xA;(с) NodaSoft 2006" sqlcode="CREATE TABLE #t (&#xA;[id] [int] IDENTITY (1, 1) NOT NULL,&#xA;[Begin] [datetime],&#xA;[End] [datetime],&#xA;[SessionCount] [int],&#xA;[OperatorName] [nvarchar] (50) COLLATE Cyrillic_General_CI_AS&#xA;) ON [PRIMARY]&#xA;&#xA;CREATE TABLE #t2 (&#xA;[id] [int] IDENTITY (1, 1) NOT NULL,&#xA;[Begin] [datetime],&#xA;[End] [datetime],&#xA;[SessionCount] [int],&#xA;[OperatorName] [nvarchar] (50) COLLATE Cyrillic_General_CI_AS&#xA;) ON [PRIMARY]&#xA;&#xA;DECLARE @Started datetime&#xA;DECLARE @PrevStarted datetime&#xA;&#xA;DECLARE sessions_cursor CURSOR FOR&#xA;   SELECT started&#xA;   FROM sessions&#xA;   ORDER BY id&#xA;&#xA;SET @PrevStarted = '01-01-2001'&#xA;&#xA;OPEN sessions_cursor&#xA;&#xA;FETCH NEXT FROM sessions_cursor INTO @Started&#xA;WHILE @@FETCH_STATUS = 0&#xA;BEGIN&#xA;		IF not @Started is null&#xA;    BEGIN&#xA;        SET @PrevStarted = @Started&#xA;				UPDATE #t SET [End] = @Started WHERE [End] is null&#xA;    END&#xA;    ELSE&#xA;    BEGIN&#xA;        INSERT INTO #t ([Begin], [End], [SessionCount], [OperatorName])&#xA;        VALUES (@PrevStarted, NULL, 1, NULL)&#xA;    END&#xA;    FETCH NEXT FROM sessions_cursor INTO @Started&#xA;END&#xA;CLOSE sessions_cursor&#xA;DEALLOCATE sessions_cursor&#xA;&#xA;UPDATE #t SET [End] = getdate() WHERE [End] is null&#xA;&#xA;&#xA;insert into #t2 select [Begin], [End], sum([SessionCount]), [OperatorName] from #t group by [Begin], [End], [OperatorName]&#xA;&#xA;delete from #t&#xA;insert into #t&#xA;select distinct T.[Begin], T.[End], T.SessionCount, U.[Name] AS OperatorName from #t2 T&#xA;    left outer join (SELECT ISNULL(op2.moment,'01-01-2001') ShiftStart,&#xA;            op.moment ShiftStop,&#xA;            op.operator id&#xA;        FROM dbo.JournalOp as Op&#xA;            left outer join dbo.JournalOp as Op2&#xA;            on (op.id = op2.id+1)) AS O&#xA; ON (T.[Begin] BETWEEN O.ShiftStart AND O.ShiftStop OR T.[End] BETWEEN O.ShiftStart AND O.ShiftStop)&#xA;    left outer join Users U ON O.id = U.id&#xA;&#xA;&#xA;update #t set [Begin] = NULL, [End]=NULL, SessionCount=NULL where id in (select t2.id from  #t AS t1&#xA;    inner JOIN #t as t2 ON t1.[Begin] = t2.[Begin] AND t1.id + 1 = t2.id)&#xA;select [Begin] [Начало периода], [End] [Конец периода], [SessionCount] [Количество сессиий], [OperatorName] [На чьи смены попадает]  from  #t&#xA;&#xA;if object_id('tempdb..#t') is not null DROP TABLE #t&#xA;if object_id('tempdb..#t2') is not null DROP TABLE #t2&#xA;&#xA;&#xA;&#xA;" version="1" tabindex="33"/></CustomReportsListd>
